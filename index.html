<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ù„ÙØ§Øª Ù…Ø¯Ø±Ø³Ø© ØªØ­ÙÙŠØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© Ø¨Ø§Ù„Ø¨Ø¬Ø§Ø¯ÙŠØ© ğŸ“‚</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet" />

    <style>
        :root {
            --primary-color: #111111; --accent-color: #c5a059; --bg-color: #f8fafc;        
            --panel-bg: #ffffff; --border-color: #e2e8f0; --text-color: #1e293b;      
            --light-text: #64748b; --hover-bg: #f1f5f9; --glass-bg: rgba(255, 255, 255, 0.7);
            --shadow-elevation: 0 10px 25px rgba(0, 0, 0, 0.05);
        }

        body.dark-mode {
            --bg-color: #0f172a; --panel-bg: #1e293b; --border-color: #334155;
            --text-color: #f1f5f9; --light-text: #94a3b8; --hover-bg: #334155;
            --glass-bg: rgba(30, 41, 59, 0.8);
        }

        body { font-family: "Almarai", sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); display: flex; min-height: 100vh; transition: 0.3s ease; }
        .container { display: flex; width: 100%; flex-grow: 1; }

        .sidebar {
            width: 380px; background-color: var(--panel-bg); border-left: 1px solid var(--border-color);
            display: flex; flex-direction: column; box-shadow: var(--shadow-elevation);
            position: sticky; top: 0; height: 100vh; z-index: 100;
        }

        .sidebar-header { 
            background-color: var(--primary-color); padding: 25px; color: white; 
            border-bottom: 3px solid var(--accent-color); position: relative; overflow: hidden;
        }

        .header-pattern { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; opacity: 0.15; }
        .square { position: absolute; background: var(--accent-color); transform: rotate(45deg); animation: rotateAndFade 8s infinite ease-in-out; }
        @keyframes rotateAndFade { 0%, 100% { transform: rotate(45deg) scale(1); opacity: 0.3; } 50% { transform: rotate(225deg) scale(1.2); opacity: 0.8; } }
        .sq1 { width: 40px; height: 40px; top: 10%; left: 10%; } .sq2 { width: 60px; height: 60px; top: 50%; left: 80%; }

        .controls-group {
            display: flex; align-items: center; gap: 15px; padding: 8px 15px;
            border: 1px solid rgba(197, 160, 89, 0.4); border-radius: 12px;
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(5px);
            width: fit-content; margin: 0 auto; position: relative; z-index: 2;
        }
        .control-icon-btn { cursor: pointer; transition: 0.3s; font-size: 1.1em; color: var(--accent-color); }
        .separator { width: 1px; height: 15px; background: var(--accent-color); opacity: 0.3; }

        .admin-controls { padding: 20px; display: flex; flex-direction: column; gap: 15px; }

        .side-input {
            width: 100%; padding: 12px 15px; border: 1px solid var(--border-color);
            border-radius: 12px; background: var(--glass-bg); color: var(--text-color); 
            font-family: inherit; transition: 0.3s; box-sizing: border-box; outline: none;
        }

        .folder-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 0 20px 15px; }
        .folder-item {
            background: var(--hover-bg); border: 1px solid var(--border-color);
            padding: 12px 8px; border-radius: 12px; cursor: pointer; text-align: center;
            font-size: 0.85em; font-weight: bold; transition: 0.2s;
            display: flex; align-items: center; gap: 8px; justify-content: center;
        }
        .folder-item i { color: var(--accent-color); } 
        .folder-item:hover, .folder-item.active { background: var(--accent-color); color: white; }
        .folder-full { grid-column: span 2; }

        .upload-btn {
            width: 100%; padding: 15px; border: none; border-radius: 15px;
            cursor: pointer; font-weight: bold; font-family: inherit;
            background: linear-gradient(135deg, var(--accent-color), #a38145);
            color: white; box-shadow: 0 4px 15px rgba(197, 160, 89, 0.3);
            display: none; align-items: center; justify-content: center; gap: 10px; transition: 0.3s;
        }

        .file-list-container { overflow-y: auto; flex-grow: 1; }
        .file-row { cursor: pointer; border-bottom: 1px solid var(--border-color); transition: 0.2s; position: relative; }
        .file-row:hover { background-color: var(--hover-bg); }
        .file-row.active { background-color: rgba(197, 160, 89, 0.1); border-right: 5px solid var(--accent-color); }
        
        .file-info { display: flex; flex-direction: column; padding: 15px 15px 15px 110px; }
        .file-info .name { font-weight: 700; font-size: 0.92em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .row-actions { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); display: flex; gap: 12px; align-items: center; }
        .row-actions i { cursor: pointer; transition: 0.2s; font-size: 1.1em; opacity: 0.8; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(11, 21, 40, 0.8); backdrop-filter: blur(8px); }
        .modal-content { 
            background: var(--panel-bg); margin: 10% auto; padding: 35px; width: 90%; max-width: 420px; 
            border-radius: 25px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            animation: slideUp 0.4s ease;
        }

        .main-content { flex-grow: 1; padding: 25px; display: flex; flex-direction: column; background-color: var(--bg-color); }
        .viewer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px;}
        #viewer { flex-grow: 1; background: #e2e8f0; border-radius: 20px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color); }
        iframe, video, img { width: 100%; height: 100%; border: none; background: white; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ù…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª */
        .audio-player-container {
            text-align: center; background: var(--panel-bg); padding: 40px; border-radius: 25px; 
            box-shadow: var(--shadow-elevation); width: 80%; max-width: 400px;
        }

        @media (max-width: 768px) { .sidebar { width: 100%; height: auto; position: static; } #viewer { min-height: 450px; } .container { flex-direction: column; } }
    </style>
</head>
<body>

    <div id="logoutModal" class="modal"><div class="modal-content">
        <div style="font-size: 3em; color: var(--accent-color); margin-bottom: 15px;"><i class="fa-solid fa-right-from-bracket"></i></div>
        <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</h3>
        <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ù…ØºØ§Ø¯Ø±Ø© ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©ØŸ</p>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="upload-btn" onclick="executeLogout()" style="display:block; flex:1;">Ø®Ø±ÙˆØ¬</button>
            <button class="side-input" onclick="closeModal('logoutModal')" style="flex:1;">Ø¨Ù‚Ø§Ø¡</button>
        </div>
    </div></div>

    <div id="tokenModal" class="modal"><div class="modal-content">
        <div style="font-size: 3em; color: var(--accent-color); margin-bottom: 15px;"><i class="fa-solid fa-user-shield"></i></div>
        <h3>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
        <input type="password" id="tokenInput" class="side-input" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ Ù‡Ù†Ø§" style="text-align:center;">
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="upload-btn" onclick="saveToken()" style="display:block;">ØªØ£ÙƒÙŠØ¯</button>
            <button class="side-input" onclick="closeModal('tokenModal')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div></div>

    <div id="deleteModal" class="modal"><div class="modal-content">
        <i class="fa-solid fa-circle-exclamation fa-4x" style="color:#ef4444; margin-bottom:15px;"></i>
        <h3>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ</h3>
        <p id="deleteMsg" style="font-weight:bold;"></p>
        <div style="display:flex; gap:10px;"><button class="upload-btn" style="display:block; background:#ef4444;" onclick="executeDelete()">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button><button class="side-input" onclick="closeModal('deleteModal')">ØªØ±Ø§Ø¬Ø¹</button></div>
    </div></div>

    <div id="renameModal" class="modal"><div class="modal-content">
        <div style="font-size: 3em; color: var(--accent-color); margin-bottom: 15px;"><i class="fa-solid fa-pen-to-square"></i></div>
        <h3>Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ©</h3>
        <input type="text" id="newNameInput" class="side-input">
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="upload-btn" onclick="executeRename()" style="display:block;">Ø­ÙØ¸</button>
            <button class="side-input" onclick="closeModal('renameModal')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div></div>

    <div id="moveModal" class="modal"><div class="modal-content">
        <h3>Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯</h3>
        <select id="moveFolderSelect" class="side-input">
            <option value="Ø£ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø£ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
            <option value="Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
            <option value="Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
            <option value="Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
            <option value="Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
            <option value="Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
            <option value="ØªØ¹Ø§Ù…ÙŠÙ…">ØªØ¹Ø§Ù…ÙŠÙ…</option>
            <option value="Ù…Ù„ÙØ§Øª Ø¹Ø§Ù…Ø©">Ù…Ù„ÙØ§Øª Ø¹Ø§Ù…Ø©</option>
        </select>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="upload-btn" onclick="executeMove()" style="display:block;">Ù†Ù‚Ù„</button>
            <button class="side-input" onclick="closeModal('moveModal')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div></div>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="header-pattern"><div class="square sq1"></div><div class="square sq2"></div></div>
                <div class="controls-group">
                    <i id="admin-icon" class="fa-solid fa-user-shield control-icon-btn" onclick="handleAdminIconClick()"></i>
                    <div class="separator"></div>
                    <i id="theme-icon" class="fa-solid fa-moon control-icon-btn" onclick="toggleTheme()"></i>
                </div>
                <h2 style="text-align:center; margin-top:20px; font-size:1.5em; color:#fff; position: relative; z-index: 2;">
                    Ù…Ø³ØªØ¹Ø±Ø¶ Ù…Ù„ÙØ§Øª Ù…Ø¯Ø±Ø³Ø© ØªØ­ÙÙŠØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø¨Ø§Ù„Ø¨Ø¬Ø§Ø¯ÙŠØ© 
                    <br><span style="font-size: 0.8em; opacity: 0.9;">"Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†"</span>
                </h2>
            </div>

            <div class="admin-controls">
                <button class="upload-btn" id="btn-upload" onclick="document.getElementById('upload-input').click()">
                    <i class="fa-solid fa-cloud-arrow-up"></i> Ø±ÙØ¹ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯
                </button>
                <input type="file" id="upload-input" style="display:none;">
                <input type="text" id="search-input" class="side-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª..." oninput="handleSearchOrFilter()">
                
                <div class="folder-grid">
                    <div class="folder-item" onclick="filterByFolder('Ø£ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ')"><i class="fa-solid fa-folder"></i> Ø£ÙˆÙ„</div>
                    <div class="folder-item" onclick="filterByFolder('Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ')"><i class="fa-solid fa-folder"></i> Ø«Ø§Ù†ÙŠ</div>
                    <div class="folder-item" onclick="filterByFolder('Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ')"><i class="fa-solid fa-folder"></i> Ø«Ø§Ù„Ø«</div>
                    <div class="folder-item" onclick="filterByFolder('Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ')"><i class="fa-solid fa-folder"></i> Ø±Ø§Ø¨Ø¹</div>
                    <div class="folder-item" onclick="filterByFolder('Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ')"><i class="fa-solid fa-folder"></i> Ø®Ø§Ù…Ø³</div>
                    <div class="folder-item" onclick="filterByFolder('Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ')"><i class="fa-solid fa-folder"></i> Ø³Ø§Ø¯Ø³</div>
                    <div class="folder-item folder-full" onclick="filterByFolder('ØªØ¹Ø§Ù…ÙŠÙ…')"><i class="fa-solid fa-bullhorn"></i> ØªØ¹Ø§Ù…ÙŠÙ…</div>
                    <div class="folder-item folder-full" onclick="filterByFolder('Ù…Ù„ÙØ§Øª Ø¹Ø§Ù…Ø©')"><i class="fa-solid fa-folder"></i> Ù…Ù„ÙØ§Øª Ø¹Ø§Ù…Ø©</div>
                </div>

                <select id="file-filter" class="side-input" onchange="handleSearchOrFilter()">
                    <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                    <option value="fav">â­ Ø§Ù„Ù…ÙØ¶Ù„Ø©</option>
                </select>
                <div id="upload-status" style="text-align:center; font-size:0.8em; font-weight:bold;"></div>
            </div>

            <div class="file-list-container"><div id="file-list"></div></div>
            <div style="padding:15px; text-align:center; font-size:0.8em; background:var(--primary-color); color:white;">Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ± NMO Â© 2026</div>
        </aside>

        <main class="main-content">
            <div class="viewer-header">
                <h2 id="current-file-name" style="margin:0; font-size:1.1em;">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</h2>
                <a href="#" id="download-btn" target="_blank" style="display:none; background:var(--accent-color); color:white; padding:8px 15px; border-radius:10px; text-decoration:none; font-size:0.9em;"><i class="fa-solid fa-download"></i> ØªØ­Ù…ÙŠÙ„</a>
            </div>
            <div id="viewer">
                <div id="viewer-empty" style="text-align:center; opacity:0.2;">
                    <i class="fa-solid fa-file-circle-question fa-5x"></i>
                    <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù…ÙØªÙˆØ­ Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const CONFIG = { username: 'nmoschool', repo: 'teacher', branch: 'main', path: 'files' };
        let allFiles = [], favorites = JSON.parse(localStorage.getItem('file_stars')) || [];
        let currentFolder = 'all', deleteTarget = null, renameTarget = null, moveTarget = null;

        const isAdmin = () => !!localStorage.getItem('github_token');
        const getStoredToken = () => localStorage.getItem('github_token');

        function openModal(id) { document.getElementById(id).style.display='block'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        
        function handleAdminIconClick() {
            if(isAdmin()) openModal('logoutModal');
            else openModal('tokenModal');
        }

        function toggleTheme() { 
            document.body.classList.toggle('dark-mode'); 
            const icon = document.getElementById('theme-icon');
            icon.classList.toggle('fa-moon'); icon.classList.toggle('fa-sun');
        }

        function executeLogout() { localStorage.removeItem('github_token'); location.reload(); }
        function saveToken() {
            const t = document.getElementById('tokenInput').value.trim();
            if(t) { localStorage.setItem('github_token', t); location.reload(); }
        }

        async function loadFromGithub() {
            if(isAdmin()) {
                document.getElementById('admin-icon').classList.replace('fa-user-shield', 'fa-unlock-keyhole');
                document.getElementById('btn-upload').style.display = 'flex';
            }
            const list = document.getElementById("file-list");
            list.innerHTML = '<center style="padding:20px;"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</center>';
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.username}/${CONFIG.repo}/contents/${CONFIG.path}?ref=${CONFIG.branch}`);
                const data = await res.json();
                if (Array.isArray(data)) {
                    allFiles = data.filter(i => i.type === 'file').reverse();
                    handleSearchOrFilter();
                }
            } catch (e) { list.innerHTML = '<center>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</center>'; }
        }

        function filterByFolder(folder) { currentFolder = folder; handleSearchOrFilter(); }

        function handleSearchOrFilter() {
            const searchVal = document.getElementById('search-input').value.toLowerCase();
            const filterVal = document.getElementById('file-filter').value;
            let filtered = allFiles;
            if (currentFolder !== 'all') filtered = filtered.filter(f => f.name.includes(`[${currentFolder}]`));
            if (searchVal) filtered = filtered.filter(f => f.name.toLowerCase().includes(searchVal));
            if (filterVal === 'fav') filtered = filtered.filter(f => favorites.includes(f.name));
            renderList(filtered);
        }

        function cleanFileName(name) { return name.replace(/\[.*?\]\s*/g, ''); }

        function renderList(files) {
            const list = document.getElementById("file-list");
            list.innerHTML = '';
            files.forEach(file => {
                const isStarred = favorites.includes(file.name);
                const div = document.createElement("div");
                div.className = "file-row";
                div.innerHTML = `
                    <div class="file-info"><span class="name">${cleanFileName(file.name)}</span></div>
                    <div class="row-actions">
                        <i class="fa-solid fa-star" style="color:${isStarred ? 'var(--accent-color)' : '#cbd5e1'}" onclick="toggleStar(event, '${file.name}')"></i>
                        ${isAdmin() ? `
                            <i class="fa-solid fa-folder-plus" style="color:var(--accent-color)" onclick="openMoveModal(event, ${JSON.stringify(file).replace(/"/g, '&quot;')})"></i>
                            <i class="fa-solid fa-pen-to-square" style="color:var(--accent-color)" onclick="openRenameModal(event, ${JSON.stringify(file).replace(/"/g, '&quot;')})"></i>
                            <i class="fa-solid fa-trash" style="color:#ef4444;" onclick="openDeleteModal(event, '${file.name}', '${file.sha}')"></i>
                        ` : ''}
                    </div>`;
                div.onclick = () => openFile(file.name, file.download_url);
                list.appendChild(div);
            });
        }

        // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù„Ø¯Ø¹Ù… ÙƒØ§ÙØ© Ø§Ù„Ø¥Ù…ØªØ¯Ø§Ø¯Ø§Øª
        function openFile(name, url) {
            document.getElementById("current-file-name").innerText = cleanFileName(name);
            document.getElementById("download-btn").style.display = "inline-flex";
            document.getElementById("download-btn").href = url;
            const viewer = document.getElementById("viewer");
            const ext = name.split('.').pop().toLowerCase();
            
            // 1. Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª (ØªÙØªØ­ Ø¹Ø¨Ø± Ø¬ÙˆØ¬Ù„)
            const docExts = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'rtf', 'csv', 'odt', 'ods', 'odp', 'pages', 'numbers', 'key'];
            // 2. Ø§Ù„ØµÙˆØ±
            const imgExts = ['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp', 'bmp', 'ico', 'tiff', 'tif'];
            // 3. Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            const vidExts = ['mp4', 'webm', 'ogg', 'mov', 'avi', 'mkv', 'flv', 'wmv', '3gp'];
            // 4. Ø§Ù„ØµÙˆØª
            const audExts = ['mp3', 'wav', 'm4a', 'aac', 'flac', 'opus', 'ogg'];

            if (docExts.includes(ext)) {
                viewer.innerHTML = `<iframe src="https://docs.google.com/gview?url=${encodeURIComponent(url)}&embedded=true"></iframe>`;
            } else if (imgExts.includes(ext)) {
                viewer.innerHTML = `<img src="${url}" style="object-fit:contain; max-width:100%; max-height:100%;">`;
            } else if (vidExts.includes(ext)) {
                viewer.innerHTML = `<video controls autoplay style="width:100%; height:100%;"><source src="${url}">Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.</video>`;
            } else if (audExts.includes(ext)) {
                viewer.innerHTML = `
                    <div class="audio-player-container">
                        <i class="fa-solid fa-file-audio fa-5x" style="color:var(--accent-color); margin-bottom:20px;"></i>
                        <audio controls autoplay style="width:100%;"><source src="${url}">Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØµÙˆØª.</audio>
                        <p style="margin-top:15px; font-size:0.9em;">${cleanFileName(name)}</p>
                    </div>`;
            } else {
                viewer.innerHTML = `
                    <div style="text-align:center; padding:30px; background:var(--panel-bg); border-radius:20px;">
                        <i class="fa-solid fa-file-zipper fa-5x" style="opacity:0.2; margin-bottom:20px;"></i>
                        <h3>Ù…Ù„Ù ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</h3>
                        <p>Ù…Ù„ÙØ§Øª ( .${ext} ) Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.</p>
                    </div>`;
            }
        }

        function toggleStar(e, name) {
            e.stopPropagation();
            if (favorites.includes(name)) favorites = favorites.filter(f => f !== name);
            else favorites.push(name);
            localStorage.setItem('file_stars', JSON.stringify(favorites));
            handleSearchOrFilter();
        }

        function openDeleteModal(e, name, sha) { e.stopPropagation(); deleteTarget = { name, sha }; document.getElementById('deleteMsg').innerText = cleanFileName(name); openModal('deleteModal'); }
        async function executeDelete() {
            const res = await fetch(`https://api.github.com/repos/${CONFIG.username}/${CONFIG.repo}/contents/${CONFIG.path}/${deleteTarget.name}`, {
                method: 'DELETE', headers: { 'Authorization': `token ${getStoredToken()}` },
                body: JSON.stringify({ message: `Delete`, sha: deleteTarget.sha, branch: CONFIG.branch })
            });
            if (res.ok) { closeModal('deleteModal'); loadFromGithub(); }
        }

        function openRenameModal(e, f) { e.stopPropagation(); renameTarget = f; document.getElementById('newNameInput').value = f.name; openModal('renameModal'); }
        async function executeRename() {
            const newN = document.getElementById('newNameInput').value.trim();
            const fRes = await fetch(renameTarget.download_url);
            const blob = await fRes.blob();
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = async () => {
                const content = reader.result.split(',')[1];
                const putRes = await fetch(`https://api.github.com/repos/${CONFIG.username}/${CONFIG.repo}/contents/${CONFIG.path}/${newN}`, {
                    method: 'PUT', headers: { 'Authorization': `token ${getStoredToken()}` },
                    body: JSON.stringify({ message: `Rename`, content, branch: CONFIG.branch })
                });
                if (putRes.ok) {
                    await fetch(`https://api.github.com/repos/${CONFIG.username}/${CONFIG.repo}/contents/${CONFIG.path}/${renameTarget.name}`, {
                        method: 'DELETE', headers: { 'Authorization': `token ${getStoredToken()}` },
                        body: JSON.stringify({ message: `Cleanup`, sha: renameTarget.sha, branch: CONFIG.branch })
                    });
                    closeModal('renameModal'); loadFromGithub();
                }
            };
        }

        function openMoveModal(e, f) { e.stopPropagation(); moveTarget = f; openModal('moveModal'); }
        async function executeMove() {
            const folder = document.getElementById('moveFolderSelect').value;
            const newName = `[${folder}] ${moveTarget.name.replace(/^\[.*?\]\s*/, '')}`;
            renameTarget = moveTarget;
            document.getElementById('newNameInput').value = newName;
            await executeRename();
            closeModal('moveModal');
        }

        document.getElementById('upload-input').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if (!file) return;
            const status = document.getElementById('upload-status');
            status.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = async () => {
                const content = reader.result.split(',')[1];
                const res = await fetch(`https://api.github.com/repos/${CONFIG.username}/${CONFIG.repo}/contents/${CONFIG.path}/${file.name}`, {
                    method: 'PUT', headers: { 'Authorization': `token ${getStoredToken()}` },
                    body: JSON.stringify({ message: `Upload`, content, branch: CONFIG.branch })
                });
                if (res.ok) { status.innerHTML = "âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹"; loadFromGithub(); }
                else { status.innerHTML = "âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹"; }
            };
        });

        loadFromGithub();
    </script>
</body>
</html>
