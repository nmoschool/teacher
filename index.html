<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ù„ÙØ§Øª Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ØªØ­ÙÙŠØ¸ ğŸ“‚</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet" />

    <style>
        :root {
            --primary-color: #0b1528; --accent-color: #c5a059; --bg-color: #f8fafc;        
            --panel-bg: #ffffff; --border-color: #e2e8f0; --text-color: #1e293b;      
            --light-text: #64748b; --hover-bg: #f1f5f9; --glass-bg: rgba(255, 255, 255, 0.7);
            --shadow-elevation: 0 10px 25px rgba(0, 0, 0, 0.05);
            --icon-pdf: #e11d48; --icon-word: #2563eb; --icon-excel: #16a34a;
            --icon-ppt: #ea580c; --icon-img: #c5a059; --icon-video: #8b5cf6;
            --icon-audio: #06b6d4; --icon-text: #64748b;
        }

        body.dark-mode {
            --bg-color: #0f172a; --panel-bg: #1e293b; --border-color: #334155;
            --text-color: #f1f5f9; --light-text: #94a3b8; --hover-bg: #334155;
            --glass-bg: rgba(30, 41, 59, 0.8);
        }

        body { font-family: "Almarai", sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); display: flex; min-height: 100vh; transition: 0.3s ease; }
        .container { display: flex; width: 100%; flex-grow: 1; }

        .sidebar {
            width: 380px; background-color: var(--panel-bg); border-left: 1px solid var(--border-color);
            display: flex; flex-direction: column; box-shadow: var(--shadow-elevation);
            position: sticky; top: 0; height: 100vh; z-index: 100;
        }

        .sidebar-header { background-color: var(--primary-color); padding: 25px; color: white; border-bottom: 3px solid var(--accent-color); }
        .sidebar-header h2 { font-size: 1.1em; margin: 15px 0 0; color: var(--accent-color); text-align: center; line-height: 1.6; }

        .admin-controls { padding: 20px; display: flex; flex-direction: column; gap: 15px; }

        .side-input {
            width: 100%; padding: 12px 15px; border: 1px solid var(--border-color);
            border-radius: 15px; background: var(--glass-bg); color: var(--text-color); 
            font-family: inherit; transition: 0.3s; box-sizing: border-box; outline: none;
        }
        .side-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(197, 160, 89, 0.2); }

        .folder-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 0 20px 15px; }
        .folder-item {
            background: var(--hover-bg); border: 1px solid var(--border-color);
            padding: 10px; border-radius: 12px; cursor: pointer; text-align: center;
            font-size: 0.82em; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 8px; justify-content: center;
        }
        .folder-item:hover { background: var(--accent-color); color: white; }
        .folder-item i { color: var(--accent-color); }
        .folder-item:hover i { color: white; }
        .folder-full { grid-column: span 2; justify-content: center; }

        .upload-btn {
            width: 100%; padding: 15px; border: none; border-radius: 15px;
            cursor: pointer; font-weight: bold; font-family: inherit;
            background: linear-gradient(135deg, var(--accent-color), #a38145);
            color: white; box-shadow: 0 4px 15px rgba(197, 160, 89, 0.3);
            display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s;
        }

        .file-list-container { overflow-y: auto; flex-grow: 1; }
        .file-row { cursor: pointer; border-bottom: 1px solid var(--border-color); transition: 0.2s; position: relative; }
        .file-row:hover { background-color: var(--hover-bg); }
        .file-row.active { background-color: rgba(197, 160, 89, 0.1); border-right: 5px solid var(--accent-color); }
        
        .file-info { display: flex; flex-direction: column; padding: 15px 70px 15px 110px; }
        .file-info .name { font-weight: 700; font-size: 0.92em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-icon-fixed { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 1.5em; }

        .row-actions { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); display: flex; gap: 10px; align-items: center; }
        .row-actions i { cursor: pointer; transition: 0.2s; font-size: 1.1em; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(11, 21, 40, 0.8); backdrop-filter: blur(8px); }
        .modal-content { 
            background: var(--panel-bg); margin: 10% auto; padding: 35px; width: 90%; max-width: 420px; 
            border-radius: 25px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            animation: slideUp 0.4s ease;
        }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .main-content { flex-grow: 1; padding: 25px; display: flex; flex-direction: column; background-color: var(--bg-color); }
        .viewer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--border-color); }
        #viewer { flex-grow: 1; background: #d1d5db; border-radius: 20px; overflow: hidden; position: relative; box-shadow: var(--shadow-elevation); }
        iframe, video, img { width: 100%; height: 100%; border: none; background: white; }

        @media (max-width: 768px) { .container { flex-direction: column; } .sidebar { width: 100%; height: auto; position: static; } #viewer { min-height: 450px; } }
    </style>
</head>
<body>

    <div id="logoutModal" class="modal"><div class="modal-content">
        <div style="font-size: 3em; color: var(--accent-color); margin-bottom: 15px;"><i class="fa-solid fa-right-from-bracket"></i></div>
        <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</h3>
        <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙˆÙ…Ø³Ø­ Ø§Ù„Ø±Ù…Ø²ØŸ</p>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="upload-btn" onclick="executeLogout()" style="flex:1;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            <button class="side-input" onclick="closeModal('logoutModal')" style="flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div></div>

    <div id="tokenModal" class="modal"><div class="modal-content">
        <div style="font-size: 3em; color: var(--accent-color); margin-bottom: 15px;"><i class="fa-solid fa-lock"></i></div>
        <h3>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©</h3>
        <input type="password" id="tokenInput" class="side-input" style="text-align: center; letter-spacing: 5px;" placeholder="ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª">
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="upload-btn" onclick="saveToken()" style="flex:2;">ØªØ£ÙƒÙŠØ¯</button>
            <button class="side-input" onclick="closeModal('tokenModal')" style="flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div></div>

    <div id="deleteModal" class="modal"><div class="modal-content">
        <i class="fa-solid fa-circle-exclamation fa-4x" style="color:#ef4444; margin-bottom:15px;"></i>
        <h3>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ</h3>
        <p id="deleteMsg" style="font-weight:bold;"></p>
        <div style="display:flex; gap:10px;"><button class="upload-btn" style="background:#ef4444;" onclick="executeDelete()">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button><button class="side-input" onclick="closeModal('deleteModal')">ØªØ±Ø§Ø¬Ø¹</button></div>
    </div></div>

    <div id="renameModal" class="modal"><div class="modal-content">
        <div style="font-size: 3em; color: var(--accent-color); margin-bottom: 15px;"><i class="fa-solid fa-pen-to-square"></i></div>
        <h3>Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ù…Ù„Ù</h3>
        <input type="text" id="newNameInput" class="side-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯...">
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="upload-btn" onclick="executeRename()">Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…</button>
            <button class="side-input" onclick="closeModal('renameModal')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div></div>

    <div id="moveModal" class="modal"><div class="modal-content">
        <h3>Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯</h3>
        <p id="moveFileName" style="color: var(--light-text); font-size: 0.85em;"></p>
        <select id="moveFolderSelect" class="side-input">
            <option value="Ø£ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø£ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
            <option value="Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
            <option value="Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
            <option value="Ø¬Ø¯Ø§ÙˆÙ„ Ø¯Ø±Ø§Ø³ÙŠØ©">Ø¬Ø¯Ø§ÙˆÙ„ Ø¯Ø±Ø§Ø³ÙŠØ©</option><option value="Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª">Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</option>
            <option value="Ù…Ù„ÙØ§Øª Ø¹Ø§Ù…Ø©">Ù…Ù„ÙØ§Øª Ø¹Ø§Ù…Ø©</option>
        </select>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="upload-btn" onclick="executeMove()">Ù†Ù‚Ù„ Ø§Ù„Ø¢Ù†</button>
            <button class="side-input" onclick="closeModal('moveModal')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div></div>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display: flex; align-items: center;">
                        <i class="fa-solid fa-right-from-bracket" onclick="openModal('logoutModal')" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬" style="cursor:pointer; font-size:1.2em; color: var(--accent-color);"></i>
                        <span style="width:2px; height:20px; background:var(--accent-color); margin:0 15px; opacity:0.3;"></span>
                        <i id="theme-icon" class="fa-solid fa-moon" onclick="toggleTheme()" style="cursor:pointer; font-size:1.2em; color: var(--accent-color);"></i>
                    </div>
                </div>
            <h2>Ù…Ø³ØªØ¹Ø±Ø¶ Ù…Ù„ÙØ§Øª Ù…Ø¯Ø±Ø³Ø© ØªØ­ÙÙŠØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø¨Ø§Ù„Ø¨Ø¬Ø§Ø¯ÙŠØ© ğŸ“‚</h2>
              <h2 style="color: #ffffff; text-align: center; font-size: 1.1em; margin: 15px 0 0; line-height: 1.6;"> "Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†" </h2>

            </div>

            <div class="admin-controls">
                <input type="file" id="upload-input" style="display: none;" />
                <button class="upload-btn" onclick="checkAuthAndUpload()">
                    <i class="fa-solid fa-cloud-arrow-up"></i> Ø±ÙØ¹ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯
                </button>
                <input type="text" id="search-input" class="side-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª..." oninput="handleSearchOrFilter()">
                
                <div class="folder-grid">
                    <div class="folder-item" onclick="filterByFolder('Ø£ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ')"><i class="fa-solid fa-folder"></i> Ø£ÙˆÙ„</div>
                    <div class="folder-item" onclick="filterByFolder('Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ')"><i class="fa-solid fa-folder"></i> Ø«Ø§Ù†ÙŠ</div>
                    <div class="folder-item" onclick="filterByFolder('Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ')"><i class="fa-solid fa-folder"></i> Ø«Ø§Ù„Ø«</div>
                    <div class="folder-item" onclick="filterByFolder('Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ')"><i class="fa-solid fa-folder"></i> Ø±Ø§Ø¨Ø¹</div>
                    <div class="folder-item" onclick="filterByFolder('Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ')"><i class="fa-solid fa-folder"></i> Ø®Ø§Ù…Ø³</div>
                    <div class="folder-item" onclick="filterByFolder('Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ')"><i class="fa-solid fa-folder"></i> Ø³Ø§Ø¯Ø³</div>
                    <div class="folder-item" onclick="filterByFolder('Ø¬Ø¯Ø§ÙˆÙ„ Ø¯Ø±Ø§Ø³ÙŠØ©')"><i class="fa-solid fa-calendar-day"></i> Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</div>
                    <div class="folder-item" onclick="filterByFolder('Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª')"><i class="fa-solid fa-file-contract"></i>Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</div>
                    <div class="folder-item folder-full" onclick="filterByFolder('Ù…Ù„ÙØ§Øª Ø¹Ø§Ù…Ø©')"><i class="fa-solid fa-box-archive"></i> Ù…Ù„ÙØ§Øª Ø¹Ø§Ù…Ø©</div>
                </div>

                <select id="file-filter" class="side-input" onchange="handleSearchOrFilter()">
                    <option value="all">ğŸ“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                    <option value="fav">â­ Ø§Ù„Ù…ÙØ¶Ù„Ø©</option>
                    <option value="pdf">ğŸ“„ PDF</option>
                    <option value="doc">ğŸ“ Word</option>
                    <option value="img">ğŸ–¼ï¸ ØµÙˆØ±</option>
                    <option value="video">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ</option>
                </select>
                <div id="upload-status" style="text-align:center; font-weight:bold; font-size:0.85em; min-height:20px;"></div>
            </div>
            
            <div class="file-list-container"><div id="file-list"></div></div>
            <div style="padding:15px; text-align:center; font-size:0.8em; background:var(--primary-color); color:white;">Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ± NMO Â© 2026</div>
        </aside>

        <main class="main-content">
            <div class="viewer-header">
                <h2 id="current-file-name" style="margin:0; font-size: 1.2em; color:var(--primary-color)">Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹ Ù„Ø¹Ø±Ø¶Ù‡</h2>
                <a href="#" id="download-btn" target="_blank" style="display:none; background:var(--accent-color); color:white; padding:10px 20px; border-radius:12px; text-decoration:none; font-weight:bold;"><i class="fa-solid fa-download"></i> ØªØ­Ù…ÙŠÙ„</a>
            </div>
            <div id="viewer">
                <div style="text-align: center; opacity: 0.3; padding-top: 150px;">
                    <i class="fa-solid fa-file-signature fa-5x"></i>
                    <p>Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const CONFIG = { username: 'nmoschool', repo: 'teacher', branch: 'main', path: 'files' };
        let allFiles = [], favorites = JSON.parse(localStorage.getItem('file_stars')) || [];
        let currentFolder = 'all'; 
        let pendingAction = null, renameTarget = null, deleteTarget = null, moveTarget = null;

        // --- Core ---
        function getStoredToken() { return localStorage.getItem('github_token'); }
        function openModal(id) { document.getElementById(id).style.display='block'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function saveToken() { const t = document.getElementById('tokenInput').value.trim(); if(t){localStorage.setItem('github_token', t); closeModal('tokenModal'); if(pendingAction) pendingAction();} }
        function toggleTheme() { document.body.classList.toggle('dark-mode'); const i = document.getElementById('theme-icon'); i.classList.toggle('fa-sun'); i.classList.toggle('fa-moon'); }

        function executeLogout() {
            localStorage.removeItem('github_token');
            closeModal('logoutModal');
            location.reload();
        }

        // --- GitHub API ---
        async function loadFromGithub() {
            const list = document.getElementById("file-list");
            list.innerHTML = '<div style="padding:20px; text-align:center;"><i class="fas fa-spinner fa-spin"></i></div>';
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.username}/${CONFIG.repo}/contents/${CONFIG.path}?ref=${CONFIG.branch}`);
                const data = await res.json();
                if (Array.isArray(data)) { 
                    allFiles = data.filter(item => item.type === 'file').reverse(); 
                    handleSearchOrFilter(); // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
                }
            } catch (e) { list.innerHTML = '<div style="color:red; text-align:center;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</div>'; }
        }

        // --- Logic & Filter ---
        function filterByFolder(folder) {
            currentFolder = folder;
            handleSearchOrFilter();
            document.getElementById("current-file-name").innerText = `Ù…Ø¬Ù„Ø¯: ${folder}`;
        }

        function handleSearchOrFilter() {
            let targetFiles = (currentFolder === 'all') ? allFiles : allFiles.filter(f => f.name.includes(`[${currentFolder}]`));
            renderList(targetFiles);
        }

        function toggleStar(e, name) {
            e.stopPropagation();
            if (favorites.includes(name)) favorites = favorites.filter(f => f !== name);
            else favorites.push(name);
            localStorage.setItem('file_stars', JSON.stringify(favorites));
            handleSearchOrFilter();
        }

        function renderList(filesToShow) {
            const list = document.getElementById("file-list");
            const filterType = document.getElementById("file-filter").value;
            const search = document.getElementById("search-input").value.toLowerCase();
            list.innerHTML = '';
            
            let filtered = filesToShow.filter(f => cleanFileName(f.name).toLowerCase().includes(search));
            if (filterType === 'fav') filtered = filtered.filter(f => favorites.includes(f.name));
            else if (filterType !== 'all') filtered = filtered.filter(f => getFileData(f.name).type === filterType);
            
            filtered.forEach(file => {
                const info = getFileData(file.name);
                const isStarred = favorites.includes(file.name);
                const div = document.createElement("div");
                div.className = "file-row";
                div.innerHTML = `
                    <div class="file-icon-fixed"><i class="fa-solid ${info.icon}" style="color:${info.color}"></i></div>
                    <div class="file-info">
                        <span class="name">${cleanFileName(file.name)}</span>
                    </div>
                    <div class="row-actions">
                        <i class="fa-solid fa-star" style="color:${isStarred ? 'var(--accent-color)' : '#cbd5e1'}" onclick="toggleStar(event, '${file.name}')"></i>
                        <i class="fa-solid fa-folder-plus" style="color:var(--accent-color)" onclick="openMoveModal(event, ${JSON.stringify(file).replace(/"/g, '&quot;')})"></i>
                        <i class="fa-solid fa-pen-to-square" style="color:var(--accent-color)" onclick="openRenameModal(event, ${JSON.stringify(file).replace(/"/g, '&quot;')})"></i>
                        <i class="fa-solid fa-trash" style="color:#ef4444;" onclick="openDeleteModal(event, '${file.name}', '${file.sha}')"></i>
                    </div>
                `;
                div.onclick = () => {
                    document.querySelectorAll('.file-row').forEach(r => r.classList.remove('active'));
                    div.classList.add('active');
                    openFile(file.name, file.download_url);
                };
                list.appendChild(div);
            });
        }

        // --- File Actions ---
        function openRenameModal(e, f) { 
            e.stopPropagation(); 
            renameTarget = f; 
            document.getElementById('newNameInput').value = f.name; 
            openModal('renameModal'); 
        }

        async function executeRename() {
            if(!getStoredToken()){ openModal('tokenModal'); return; }
            const newN = document.getElementById('newNameInput').value.trim();
            if(!newN) return;
            
            const status = document.getElementById('upload-status');
            status.innerHTML = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØºÙŠÙŠØ±...";
            
            try {
                // 1. Ø¬Ù„Ø¨ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ
                const fRes = await fetch(renameTarget.download_url);
                const blob = await fRes.blob();
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = async () => {
                    const content = reader.result.split(',')[1];
                    // 2. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    const putRes = await fetch(`https://api.github.com/repos/${CONFIG.username}/${CONFIG.repo}/contents/${CONFIG.path}/${newN}`, {
                        method: 'PUT', headers: { 'Authorization': `token ${getStoredToken()}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: `Rename to ${newN}`, content, branch: CONFIG.branch })
                    });
                    if (putRes.ok) {
                        // 3. Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…
                        await fetch(`https://api.github.com/repos/${CONFIG.username}/${CONFIG.repo}/contents/${CONFIG.path}/${renameTarget.name}`, {
                            method: 'DELETE', headers: { 'Authorization': `token ${getStoredToken()}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: `Cleanup old file`, sha: renameTarget.sha, branch: CONFIG.branch })
                        });
                        status.innerHTML = "âœ… ØªÙ… Ø¨Ù†Ø¬Ø§Ø­";
                        closeModal('renameModal');
                        loadFromGithub();
                    }
                };
            } catch (err) { alert("Ø®Ø·Ø£: " + err.message); }
        }

        async function executeDelete() {
            if(!getStoredToken()){ openModal('tokenModal'); return; }
            const status = document.getElementById('upload-status');
            status.innerHTML = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...";
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.username}/${CONFIG.repo}/contents/${CONFIG.path}/${deleteTarget.name}`, {
                    method: 'DELETE', headers: { 'Authorization': `token ${getStoredToken()}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: `Delete`, sha: deleteTarget.sha, branch: CONFIG.branch })
                });
                if (res.ok) { status.innerHTML = "âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù"; closeModal('deleteModal'); loadFromGithub(); }
            } catch (err) { status.innerHTML = "âŒ Ø®Ø·Ø£"; }
        }

        // --- Helper Funcs ---
        function getFileData(name) {
            const ext = name.split('.').pop().toLowerCase();
            const types = {
                pdf: { icon: 'fa-file-pdf', color: 'var(--icon-pdf)', type: 'pdf' },
                doc: { icon: 'fa-file-word', color: 'var(--icon-word)', type: 'doc' },
                docx: { icon: 'fa-file-word', color: 'var(--icon-word)', type: 'doc' },
                jpg: { icon: 'fa-file-image', color: 'var(--icon-img)', type: 'img' },
                png: { icon: 'fa-file-image', color: 'var(--icon-img)', type: 'img' },
                mp4: { icon: 'fa-file-video', color: 'var(--icon-video)', type: 'video' }
            };
            return types[ext] || { icon: 'fa-file-lines', color: 'var(--icon-text)', type: 'txt' };
        }

        function cleanFileName(name) { return name.replace(/\[.*?\]\s*/g, ''); }

        function openFile(name, url) {
            document.getElementById("current-file-name").innerText = cleanFileName(name);
            const viewer = document.getElementById("viewer");
            const ext = name.split('.').pop().toLowerCase();
            document.getElementById("download-btn").style.display = "inline-flex";
            document.getElementById("download-btn").href = url;
            viewer.innerHTML = '<div style="padding:50px; text-align:center;"><i class="fas fa-spinner fa-spin fa-3x"></i></div>';
            
            setTimeout(() => {
                if (['mp4', 'mov', 'webm'].includes(ext)) viewer.innerHTML = `<video controls autoplay><source src="${url}"></video>`;
                else if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) viewer.innerHTML = `<img src="${url}" style="object-fit:contain;">`;
                else if (['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].includes(ext)) viewer.innerHTML = `<iframe src="https://docs.google.com/gview?url=${encodeURIComponent(url)}&embedded=true"></iframe>`;
                else viewer.innerHTML = `<div style="text-align:center; padding-top:100px;"><p>Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø©</p></div>`;
            }, 300);
        }

        function openDeleteModal(e, name, sha) { e.stopPropagation(); deleteTarget = { name, sha }; document.getElementById('deleteMsg').innerText = cleanFileName(name); openModal('deleteModal'); }
        function openMoveModal(e, f) { e.stopPropagation(); moveTarget = f; document.getElementById('moveFileName').innerText = cleanFileName(f.name); openModal('moveModal'); }
        async function executeMove() {
            if(!getStoredToken()){ openModal('tokenModal'); return; }
            const folder = document.getElementById('moveFolderSelect').value;
            const newName = `[${folder}] ${moveTarget.name.replace(/^\[.*?\]\s*/, '')}`;
            renameTarget = moveTarget;
            document.getElementById('newNameInput').value = newName;
            await executeRename();
            closeModal('moveModal');
        }

        function checkAuthAndUpload() { if (!getStoredToken()) { pendingAction = () => document.getElementById('upload-input').click(); openModal('tokenModal'); } else document.getElementById('upload-input').click(); }

        document.getElementById('upload-input').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if (!file) return;
            const status = document.getElementById('upload-status');
            status.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = async () => {
                const content = reader.result.split(',')[1];
                const res = await fetch(`https://api.github.com/repos/${CONFIG.username}/${CONFIG.repo}/contents/${CONFIG.path}/${file.name}`, {
                    method: 'PUT', headers: { 'Authorization': `token ${getStoredToken()}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: `Upload`, content, branch: CONFIG.branch })
                });
                if (res.ok) { status.innerHTML = "âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹"; loadFromGithub(); }
            };
        });

        loadFromGithub();
    </script>
</body>
</html>
